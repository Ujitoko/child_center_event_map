name: Daily Scrape

on:
  schedule:
    # JST 06:00 = UTC 21:00 (previous day)
    - cron: '0 21 * * *'
  workflow_dispatch: # manual trigger

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Wake up Render service
        run: |
          BASE_URL="${{ secrets.RENDER_URL }}"
          BASE_URL="${BASE_URL%/}"
          echo "Waking up ${BASE_URL}..."
          curl -s --retry 5 --retry-delay 10 --retry-all-errors --max-time 120 \
            "${BASE_URL}/api/health" -o /dev/null -w "Health: HTTP %{http_code}\n"
      - name: Trigger refresh
        run: |
          BASE_URL="${{ secrets.RENDER_URL }}"
          BASE_URL="${BASE_URL%/}"
          echo "Requesting refresh..."
          HTTP_CODE=$(curl -s --retry 3 --retry-delay 30 --retry-all-errors --max-time 300 \
            "${BASE_URL}/api/events?refresh=1" \
            -o /dev/null -w "%{http_code}")
          echo "HTTP ${HTTP_CODE}"
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::Refresh failed with HTTP ${HTTP_CODE}"
            exit 1
          fi
