name: Daily Scrape

on:
  schedule:
    # JST 06:00 = UTC 21:00 (previous day)
    - cron: '0 21 * * *'
  workflow_dispatch: # manual trigger

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Wake up Render service
        run: |
          BASE_URL="${{ secrets.RENDER_URL }}"
          BASE_URL="${BASE_URL%/}"
          echo "Waking up ${BASE_URL}..."
          curl -s --retry 5 --retry-delay 10 --retry-all-errors --max-time 120 \
            "${BASE_URL}/api/health" -o /dev/null -w "Health: HTTP %{http_code}\n"

      - name: Trigger refresh and download snapshot
        run: |
          BASE_URL="${{ secrets.RENDER_URL }}"
          BASE_URL="${BASE_URL%/}"
          echo "Requesting refresh..."
          set +e
          HTTP_CODE=$(curl -s --retry 3 --retry-delay 30 --retry-all-errors --max-time 300 \
            "${BASE_URL}/api/events?refresh=1" \
            -o data/events_snapshot.json -w "%{http_code}")
          CURL_EXIT=$?
          set -e
          echo "curl exit code: ${CURL_EXIT}"
          echo "HTTP ${HTTP_CODE}"
          if [ "$CURL_EXIT" -ne 0 ]; then
            echo "::warning::curl failed with exit code ${CURL_EXIT}, checking service health..."
            HEALTH=$(curl -sf --max-time 30 "${BASE_URL}/api/health" 2>&1 || true)
            echo "Health: ${HEALTH}"
            echo "::error::Refresh request failed (curl exit ${CURL_EXIT})"
            exit 1
          fi
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::Refresh failed with HTTP ${HTTP_CODE}"
            exit 1
          fi
          ITEMS=$(python3 -c "import json; d=json.load(open('data/events_snapshot.json')); print(d.get('count', 0))")
          echo "Snapshot saved: ${ITEMS} items"

      - name: Commit snapshot
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/events_snapshot.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update events snapshot $(date -u +%Y-%m-%d)"
            git push
          fi
